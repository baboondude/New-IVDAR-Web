<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intrinsic Value Dynamic Asset Reallocation</title>
    
    <!-- Mobile Redirection Script -->
    <script>
        // Device detection function
        function isMobileDevice() {
            return (window.innerWidth <= 768) || 
                   (navigator.userAgent.match(/Android/i) ||
                    navigator.userAgent.match(/webOS/i) ||
                    navigator.userAgent.match(/iPhone/i) ||
                    navigator.userAgent.match(/iPad/i) ||
                    navigator.userAgent.match(/iPod/i) ||
                    navigator.userAgent.match(/BlackBerry/i) ||
                    navigator.userAgent.match(/Windows Phone/i));
        }
        
        // Redirect to mobile version if on a mobile device
        // Skip redirection if "desktop=true" is in the URL (to allow users to view desktop version)
        if (isMobileDevice() && window.location.href.indexOf('desktop=true') === -1) {
            window.location.href = 'mobile.html';
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            /* --- Ultra Modern Theme --- */
            --bg-color: #0A0D14; /* Darker background with subtle blue tint */
            --card-bg-color: #12151C; /* Darker card background */
            --card-bg-gradient: linear-gradient(135deg, #141821, #0E1017); /* Subtle gradient */
            --text-color: #F1F5F9; /* Slightly off-white for better contrast */
            --text-muted-color: #94A3B8; /* Slate-300 from Tailwind */
            --border-color: #1E293B; /* Darker border */
            --accent-color: #3B82F6; /* Blue-500 from Tailwind */
            --secondary-accent: #60A5FA; /* Blue-400 from Tailwind */
            --positive-color: #10B981; /* Emerald-500 from Tailwind */
            --negative-color: #EF4444; /* Red-500 from Tailwind */
            --highlight-color: rgba(59, 130, 246, 0.08); /* Adjusted highlight */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --border-radius: 12px; /* Slightly larger radius */
            --border-radius-sm: 8px; /* Smaller radius for buttons/controls */
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.1); /* Multi-layered shadow */
            --card-border: 1px solid rgba(255, 255, 255, 0.03); /* Almost invisible border */
            --nav-height: 70px;
        }

        /* Navigation */
        .navbar {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 13, 20, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            height: var(--nav-height);
            z-index: 1000;
            display: flex;
            align-items: center;
        }

        .navbar-container {
            max-width: 1800px;
            width: 100%;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo-icon {
            color: var(--accent-color);
            font-size: 24px;
            margin-right: 12px;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--accent-color), var(--secondary-accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        .nav-links li a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 0;
            position: relative;
            transition: color 0.2s ease;
        }

        .nav-links li a:hover {
            color: var(--accent-color);
        }

        .nav-links li a.active {
            color: var(--accent-color);
        }

        .nav-links li a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .date-badge {
            background: rgba(18, 21, 28, 0.7);
            padding: 8px 14px;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            color: var(--text-muted-color);
            border: 1px solid var(--border-color);
        }

        .date-badge i {
            margin-right: 8px;
            color: var(--accent-color);
        }

        .momentum-badge {
            background: rgba(18, 21, 28, 0.7);
            padding: 8px 14px;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-color);
            border: 1px solid var(--border-color);
        }

        .momentum-badge i {
            margin-right: 8px;
        }
        
        /* Mobile menu toggle */
        .menu-toggle {
            display: none;
            flex-direction: column;
            justify-content: space-between;
            width: 30px;
            height: 21px;
            cursor: pointer;
        }
        
        .menu-toggle span {
            display: block;
            height: 3px;
            width: 100%;
            background-color: var(--text-color);
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        .menu-toggle.active span:nth-child(1) {
            transform: translateY(9px) rotate(45deg);
        }
        
        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }
        
        .menu-toggle.active span:nth-child(3) {
            transform: translateY(-9px) rotate(-45deg);
        }
        
        @media (max-width: 992px) {
            .menu-toggle {
                display: flex;
            }
            
            .nav-links {
                position: fixed;
                top: var(--nav-height);
                left: -100%;
                width: 80%;
                max-width: 300px;
                height: calc(100vh - var(--nav-height));
                flex-direction: column;
                background: var(--card-bg-gradient);
                padding: 30px;
                gap: 20px;
                transition: left 0.3s ease;
                border-right: 1px solid var(--border-color);
                z-index: 999;
            }
            
            .nav-links.active {
                left: 0;
            }
            
            .user-menu {
                flex-direction: column;
                gap: 10px;
                align-items: flex-end;
            }
            
            .page-title {
                font-size: 1.8rem;
            }
            
            .page-subtitle {
                font-size: 1rem;
            }
            
            .bold-first-letter {
                font-size: 1em;
            }
        }
        
        @media (max-width: 576px) {
            .navbar-container {
                padding: 0 15px;
            }
            
            .container {
                padding: 0 15px;
            }
            
            .logo-text {
                font-size: 1.3rem;
            }
            
            .user-menu {
                display: none;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .bold-first-letter {
                font-size: 1em;
            }
        }

        /* Page title */
        .page-header {
            text-align: center;
            padding: 40px 0 30px;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 12px;
            background: linear-gradient(to right, var(--accent-color), var(--secondary-accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.2;
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted-color);
            max-width: 700px;
            margin: 0 auto;
        }
        
        .bold-first-letter {
            font-weight: 800;
            font-size: 1.1em;
            color: var(--accent-color);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            /* Enhanced background */
            background-image: 
                radial-gradient(circle at 105% -5%, rgba(59, 130, 246, 0.07), transparent 45%),
                radial-gradient(circle at -5% 105%, rgba(59, 130, 246, 0.05), transparent 40%);
            background-attachment: fixed;
            background-size: 100% 100%;
        }

        .container {
            max-width: 1800px; /* Wider container */
            margin: auto;
            padding: 0 30px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        header h1 {
            margin: 0;
            font-size: 2.1em;
            font-weight: 700;
            background: linear-gradient(to right, var(--accent-color), var(--secondary-accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.8px;
        }

        header .date-momentum {
            text-align: right;
            color: var(--text-muted-color);
            font-size: 0.9em;
            background: rgba(18, 21, 28, 0.7);
            padding: 10px 16px;
            border-radius: var(--border-radius-sm);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        header .date-momentum p {
            margin: 2px 0;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 25px;
        }

        .card {
            background: var(--card-bg-gradient);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--box-shadow);
            border: var(--card-border);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, var(--accent-color), var(--secondary-accent));
            opacity: 0.8;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25), 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 18px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 14px;
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
        }
        
        .card h2::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 16px;
            background-color: var(--accent-color);
            border-radius: 2px;
            margin-right: 10px;
            box-shadow: 0 0 8px 1px rgba(59, 130, 246, 0.4);
        }

        .card-large {
             grid-column: span 1; /* Default */
        }
        @media (min-width: 1200px) {
             .card-large {
                 grid-column: span 2;
             }
        }
         @media (max-width: 800px) {
             .card-large {
                 grid-column: span 1;
             }
             .grid-container {
                 grid-template-columns: 1fr;
             }
         }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            text-align: left;
            padding: 14px 12px;
            border-bottom: 1px solid rgba(30, 41, 59, 0.6);
            font-size: 0.9em;
            vertical-align: middle;
        }

        th {
            color: var(--text-muted-color);
            font-weight: 500;
            white-space: nowrap;
            text-transform: uppercase;
            font-size: 0.7em;
            letter-spacing: 0.8px;
        }

        td {
             white-space: nowrap;
        }
        
        tbody tr {
            transition: background-color 0.2s ease;
        }
        
        tbody tr:hover {
            background-color: var(--highlight-color);
        }

        .positive { color: var(--positive-color); font-weight: 600; }
        .negative { color: var(--negative-color); font-weight: 600; }
        .muted { color: var(--text-muted-color); font-style: italic; }

        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-item {
            background: var(--card-bg-gradient);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            border: var(--card-border);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .summary-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25), 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .summary-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, var(--accent-color), var(--secondary-accent));
            opacity: 0.8;
        }

        .summary-item h3 {
            margin: 0 0 10px 0;
            font-size: 0.75em;
            color: var(--text-muted-color);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .summary-item p {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-color);
            background: linear-gradient(to right, var(--accent-color), var(--secondary-accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        /* ApexCharts specific styles adjustments */
        .apexcharts-tooltip {
            background: rgba(18, 21, 28, 0.95) !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: var(--border-radius-sm) !important;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3) !important;
            font-family: var(--font-family) !important;
            backdrop-filter: blur(8px);
        }
        .apexcharts-tooltip .apexcharts-tooltip-title {
            background: rgba(20, 24, 33, 0.8) !important;
            border-bottom: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
            font-weight: 600;
            padding: 8px 12px;
            font-size: 12px;
        }
        .apexcharts-tooltip .apexcharts-tooltip-series-group {
             padding: 8px 12px;
             font-size: 12px;
        }
         .apexcharts-legend-text {
             color: var(--text-muted-color) !important;
             font-size: 12px !important;
             font-family: var(--font-family) !important;
         }
         
         .apexcharts-legend-series {
             transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
         }
         
         .apexcharts-legend-series:hover {
             transform: translateY(-2px);
             filter: brightness(1.1);
         }
         
         .apexcharts-xaxis-label, .apexcharts-yaxis-label {
              fill: var(--text-muted-color) !important;
              font-family: var(--font-family) !important;
              font-size: 11px;
         }
         .apexcharts-yaxis-title-text, .apexcharts-xaxis-title-text {
             fill: var(--text-muted-color) !important;
             font-family: var(--font-family) !important;
             font-size: 12px;
             font-weight: 500;
         }
         .apexcharts-title-text {
             fill: var(--text-color) !important;
             font-family: var(--font-family) !important;
             font-weight: 600;
             font-size: 16px !important;
         }
          .apexcharts-datalabel, .apexcharts-datalabel-label, .apexcharts-datalabel-value, .apexcharts-data-labels {
             fill: #fff !important;
             font-weight: 600;
             font-size: 11px !important;
             text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
         }
         .apexcharts-pie-label {
             fill: var(--text-color) !important;
             font-weight: 600;
             filter: none !important;
             font-size: 12px !important;
         }

         /* Grid lines */
         .apexcharts-grid line {
             stroke: rgba(30, 41, 59, 0.3) !important;
         }
         
         /* Chart animations */
         .apexcharts-canvas .apexcharts-element-shown {
             transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
         }
         
         /* Donut center text */
         .apexcharts-datalabels-group text {
             fill: var(--text-color) !important;
             font-weight: 700 !important;
             font-size: 18px !important;
         }
         
         /* Bar chart styling */
         .apexcharts-bar-area {
             stroke-width: 0 !important;
             transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
         }
         
         .apexcharts-bar-area:hover {
             filter: brightness(1.2);
         }

         /* Target Allocation Interactive Styles */
         .allocation-container {
             display: flex;
             flex-wrap: wrap;
             gap: 24px;
             align-items: stretch;
         }

         #allocation-chart {
             flex: 1;
             min-width: 280px;
             min-height: 360px;
             height: 360px;
         }

         #allocation-details {
             flex: 1;
             min-width: 250px;
             background: var(--card-bg-gradient);
             border-radius: var(--border-radius);
             padding: 22px;
             border: var(--card-border);
             display: flex;
             flex-direction: column;
             justify-content: space-between;
             box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
         }

         .allocation-info {
             margin-bottom: 20px;
             text-align: center;
         }

         .allocation-info h3 {
             margin: 0 0 10px 0;
             color: var(--text-muted-color);
             font-size: 0.8em;
             text-transform: uppercase;
             letter-spacing: 0.8px;
             font-weight: 600;
         }

         .allocation-value {
             font-size: 1.7em;
             font-weight: 700;
             background: linear-gradient(to right, var(--accent-color), var(--secondary-accent));
             -webkit-background-clip: text;
             background-clip: text;
             -webkit-text-fill-color: transparent;
             padding: 10px 0;
             letter-spacing: -0.5px;
         }

         .allocation-controls,
         .scenario-controls,
         .valuation-sort-controls {
             display: flex;
             justify-content: center;
             gap: 10px;
             margin-bottom: 20px;
         }

         .allocation-controls button,
         .scenario-controls button,
         .valuation-sort-controls button {
             background: rgba(18, 21, 28, 0.7);
             border: 1px solid var(--border-color);
             color: var(--text-muted-color);
             padding: 8px 14px;
             border-radius: 20px; /* More rounded buttons */
             cursor: pointer;
             transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
             font-family: var(--font-family);
             font-size: 0.85em;
             font-weight: 500;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
         }

         .allocation-controls button:hover,
         .scenario-controls button:hover,
         .valuation-sort-controls button:hover {
             background: var(--highlight-color);
             color: var(--text-color);
             border-color: var(--accent-color);
             transform: translateY(-2px);
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
         }

         .allocation-controls button.active,
         .scenario-controls button.active,
         .valuation-sort-controls button.active {
             background: var(--accent-color);
             color: #fff;
             border-color: var(--accent-color);
             font-weight: 600;
             box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
         }

         .allocation-stats {
             background: rgba(18, 21, 28, 0.6);
             border-radius: var(--border-radius-sm);
             padding: 16px;
             box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
             border: 1px solid var(--border-color);
         }

         .stat-item {
             display: flex;
             justify-content: space-between;
             margin-bottom: 10px;
             padding-bottom: 10px;
             border-bottom: 1px solid var(--border-color);
             font-size: 0.9em;
         }

         .stat-item:last-child {
             margin-bottom: 0;
             padding-bottom: 0;
             border-bottom: none;
         }

         .stat-label {
             color: var(--text-muted-color);
         }

         .stat-value {
             font-weight: 600;
         }

         /* Scenario description */
         #scenario-description {
             font-size: 0.85em;
             color: var(--text-muted-color);
             text-align: center;
             margin-top: 12px;
             min-height: 2.5em;
             font-style: italic;
             padding: 0 10px;
         }

         @media (max-width: 1100px) {
             .allocation-container {
                 flex-direction: column;
             }
             #allocation-chart {
                 min-height: 300px;
                 height: 300px;
             }
         }
         
         /* Footer styles */
         .site-footer {
             background: var(--card-bg-gradient);
             border-top: 1px solid var(--border-color);
             padding: 60px 0 30px;
             margin-top: 50px;
         }
         
         .footer-content {
             display: flex;
             flex-wrap: wrap;
             justify-content: space-between;
             margin-bottom: 40px;
         }
         
         .footer-logo {
             flex: 0 0 300px;
             margin-bottom: 30px;
         }
         
         .footer-tagline {
             color: var(--text-muted-color);
             margin-top: 15px;
             font-size: 0.9rem;
             padding-right: 20px;
         }
         
         .footer-links {
             display: flex;
             flex-wrap: wrap;
             gap: 40px;
         }
         
         .footer-section h3 {
             color: var(--text-color);
             font-size: 1rem;
             font-weight: 600;
             margin-bottom: 20px;
             position: relative;
             display: inline-block;
         }
         
         .footer-section h3::after {
             content: '';
             position: absolute;
             left: 0;
             bottom: -8px;
             height: 2px;
             width: 30px;
             background: var(--accent-color);
             border-radius: 2px;
         }
         
         .footer-section ul {
             list-style: none;
             padding: 0;
             margin: 0;
         }
         
         .footer-section ul li {
             margin-bottom: 12px;
         }
         
         .footer-section ul li a {
             color: var(--text-muted-color);
             text-decoration: none;
             transition: color 0.2s ease;
             font-size: 0.9rem;
         }
         
         .footer-section ul li a:hover {
             color: var(--accent-color);
         }
         
         .footer-bottom {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding-top: 30px;
             border-top: 1px solid var(--border-color);
         }
         
         .copyright {
             color: var(--text-muted-color);
             font-size: 0.85rem;
         }
         
         .social-links {
             display: flex;
             gap: 16px;
         }
         
         .social-links a {
             color: var(--text-muted-color);
             font-size: 1.2rem;
             transition: color 0.2s ease;
         }
         
         .social-links a:hover {
             color: var(--accent-color);
         }
         
         @media (max-width: 768px) {
             .footer-content {
                 flex-direction: column;
             }
             
             .footer-logo, .footer-links {
                 flex: 0 0 100%;
             }
             
             .footer-bottom {
                 flex-direction: column;
                 gap: 15px;
                 text-align: center;
             }
         }
         
         /* --- Accessibility --- */
         a:focus-visible,
         button:focus-visible,
         .menu-toggle:focus-visible {
             outline: 2px solid var(--accent-color);
             outline-offset: 2px;
             box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); /* Subtle focus ring */
         }
         
         /* Focus styles specifically for nav links */
         .nav-links li a:focus-visible {
             color: var(--accent-color);
         }
         
         /* Focus style for allocation buttons */
         .allocation-controls button:focus-visible,
         .scenario-controls button:focus-visible,
         .valuation-sort-controls button:focus-visible {
             border-color: var(--accent-color);
         }

         /* Allocation Details Tags Styling (Moved from JS) */
         .allocation-detail-text {
             font-size: 0.85rem;
             margin-top: 8px;
             color: var(--text-muted-color);
             font-weight: normal;
             line-height: 1.4;
             /* Override potential gradient text styles */
             -webkit-text-fill-color: currentColor;
             background-clip: initial;
             background: none;
         }
         
         .allocation-metadata {
             display: flex;
             gap: 8px;
             flex-wrap: wrap;
             margin-top: 15px;
             justify-content: center;
         }
         
         .tag {
             display: inline-block;
             padding: 4px 10px;
             border-radius: 20px;
             font-size: 0.7rem;
             font-weight: 600;
             color: #fff; /* White text generally works best */
             background: var(--border-color); /* Default background */
             -webkit-text-fill-color: currentColor; /* Override potential gradient */
             background-clip: initial;
             letter-spacing: 0.5px;
             box-shadow: 0 2px 4px rgba(0,0,0,0.2);
             text-transform: capitalize; /* Capitalize risk levels */
         }
         
         .horizon-tag {
             background: var(--accent-color);
             opacity: 0.9;
         }
         
         /* Risk Tag Colors */
         .risk-very-low { background-color: var(--positive-color); }
         .risk-low { background-color: #38B2AC; } /* Teal */
         .risk-medium { background-color: #F6AD55; } /* Amber */
         .risk-medium-high { background-color: #F56565; } /* Red */
         .risk-high { background-color: var(--negative-color); }
         
         /* Custom ApexCharts Tooltip (Moved from JS - optional, alternative to default) */
         .apexcharts-tooltip-custom {
            padding: 10px 15px;
            background: rgba(18, 21, 28, 0.95); /* Match existing tooltip bg */
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            font-family: var(--font-family);
            backdrop-filter: blur(8px);
         }
         
         /* Animation Keyframes */
         @keyframes fadeIn {
             from { opacity: 0; }
             to { opacity: 1; }
         }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-chart-line"></i></div>
                <div class="logo-text">IVDAR</div>
            </div>
            <div class="menu-toggle" id="mobile-menu">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-links" id="nav-menu">
                <li><a href="#" class="active">Dashboard</a></li>
                <li><a href="#">Portfolio</a></li>
                <li><a href="#">Analytics</a></li>
                <li><a href="#">Market</a></li>
                <li><a href="#">News</a></li>
            </ul>
            <div class="user-menu">
                <div class="date-badge">
                    <i class="far fa-calendar-alt"></i> Sunday 4/13/2025
                </div>
                <div class="momentum-badge">
                    <i class="fas fa-chart-bar"></i> Momentum: 24.77
                </div>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <h1 class="page-title"><span class="bold-first-letter">I</span>ntrinsic <span class="bold-first-letter">V</span>alue <span class="bold-first-letter">D</span>ynamic <span class="bold-first-letter">A</span>sset <span class="bold-first-letter">R</span>eallocation</h1>
            <p class="page-subtitle">An Enlightened Approach to Long Term Investing</p>
        </div>
    </div>

    <div class="container">
        <main>
            <section class="summary-section">
                <div class="summary-item">
                    <h3>Target Stock Total</h3>
                    <p>71.87%</p>
                </div>
                <div class="summary-item">
                    <h3>Implied Allocation</h3>
                    <p>74.78%</p>
                </div>
                 <div class="summary-item">
                    <h3>Pop. Mean (Gaussian)</h3>
                    <p>0.41%</p>
                </div>
                 <div class="summary-item">
                    <h3>Pop. SD (Gaussian)</h3>
                    <p>24.85%</p>
                </div>
            </section>

            <div class="grid-container">
                <div class="card card-large">
                    <h2>Target Allocation</h2>
                    <div class="allocation-container">
                        <div id="allocation-chart"></div>
                        <div id="allocation-details">
                            <div class="allocation-info">
                                <h3>Selected Asset</h3>
                                <div class="allocation-value">Click a segment to view details</div>
                            </div>
                            <div class="allocation-controls">
                                <button id="view-as-donut" class="active">Donut</button>
                                <button id="view-as-bar">Bar</button>
                            </div>
                            <div class="allocation-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Stock Total:</span>
                                    <span class="stat-value" id="stock-total">71.87%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Bonds:</span>
                                    <span class="stat-value">3.57%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Cash:</span>
                                    <span class="stat-value">24.67%</span>
                                </div>
                            </div>
                            
                            <!-- Portfolio Calculator -->
                            <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; animation: fadeIn 0.5s ease;">
                                <h3 style="font-size: 1rem; color: var(--text-muted-color); margin-bottom: 15px; display: flex; align-items: center;">
                                    <i class="fas fa-calculator" style="margin-right: 8px; color: var(--accent-color);"></i>
                                    Portfolio Calculator
                                </h3>
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                                        <div style="flex: 1;">
                                            <label for="portfolioValue" style="display: block; font-size: 0.8rem; color: var(--text-muted-color); margin-bottom: 5px;">Enter Portfolio Value:</label>
                                            <div style="display: flex; align-items: center; background: rgba(18, 21, 28, 0.7); border-radius: var(--border-radius-sm); overflow: hidden; border: 1px solid var(--border-color);">
                                                <span style="padding: 10px 12px; color: var(--text-muted-color); font-weight: bold;">$</span>
                                                <input type="number" id="portfolioValue" placeholder="100,000" style="background: transparent; border: none; color: var(--text-color); padding: 10px 12px; width: 100%; font-size: 1rem;" />
                                            </div>
                                        </div>
                                        <button id="calculateBtn" style="background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s ease; height: 41px;">
                                            Calculate
                                        </button>
                                    </div>
                                </div>
                                <div id="calculationResults" style="display: none; background: rgba(18, 21, 28, 0.5); border-radius: var(--border-radius-sm); padding: 15px; border: 1px solid var(--border-color); animation: fadeIn 0.3s ease;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h4 style="margin: 0; font-size: 0.9rem;">Allocation Breakdown</h4>
                                        <span id="totalAmount" style="font-weight: 600; color: var(--accent-color);"></span>
                                    </div>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                        <thead>
                                            <tr>
                                                <th style="text-align: left; padding: 8px; color: var(--text-muted-color); font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--border-color);">Asset</th>
                                                <th style="text-align: right; padding: 8px; color: var(--text-muted-color); font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--border-color);">Allocation %</th>
                                                <th style="text-align: right; padding: 8px; color: var(--text-muted-color); font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--border-color);">Dollar Amount</th>
                                                <th style="text-align: right; padding: 8px; color: var(--text-muted-color); font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--border-color);">Current Price</th>
                                            </tr>
                                        </thead>
                                        <tbody id="calculationResultsBody">
                                            <!-- Results will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                    <div style="margin-top: 15px; font-size: 0.8rem; color: var(--text-muted-color); font-style: italic; text-align: center;">
                                        This is an approximate allocation based on target percentages. Actual investment amounts may vary due to share pricing.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Estimated One Year Returns</h2>
                    <div class="scenario-controls">
                        <button id="returns-base" class="active">Base Case</button>
                        <button id="returns-optimistic">Optimistic</button>
                        <button id="returns-pessimistic">Pessimistic</button>
                    </div>
                    <div id="returns-chart" style="min-height: 380px;"></div>
                    <p id="scenario-description">Expected market returns based on historical averages and current conditions.</p>
                    
                    <!-- Dollar Returns Table - Hidden until portfolio value is entered -->
                    <div id="dollarReturnsSection" style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); animation: fadeIn 0.5s ease;">
                        <h3 style="font-size: 1rem; color: var(--text-color); margin-bottom: 15px; display: flex; align-items: center;">
                            <i class="fas fa-dollar-sign" style="margin-right: 8px; color: var(--accent-color); font-size: 0.9rem;"></i>
                            Estimated Dollar Returns
                        </h3>
                        <div class="table-container" style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th style="text-align: right;">Allocation</th>
                                        <th style="text-align: right;">Est. 1Y Return</th>
                                        <th style="text-align: right;">Dollar Return</th>
                                    </tr>
                                </thead>
                                <tbody id="desktop-dollar-returns-body">
                                    <!-- Results will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.8rem; color: var(--text-muted-color); font-style: italic; text-align: center;">
                            Based on portfolio value: <span id="desktopPortfolioValueDisplay">$0</span>
                        </div>
                    </div>
                </div>

                <div class="card card-large">
                    <h2>Valuation (Overprice %)</h2>
                    <div class="valuation-sort-controls">
                        <button id="valuation-sort-default" class="active">Default</button>
                        <button id="valuation-sort-overpriced">Overpriced First</button>
                        <button id="valuation-sort-underpriced">Underpriced First</button>
                    </div>
                    <div id="overprice-chart" style="min-height: 380px; width: 100%;"></div>
                    
                    <!-- Dollar Valuation Impact Table - Hidden until portfolio value is entered -->
                    <div id="desktop-dollar-valuation-section" style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); animation: fadeIn 0.5s ease;">
                        <h3 style="font-size: 1rem; color: var(--text-color); margin-bottom: 15px; display: flex; align-items: center;">
                            <i class="fas fa-balance-scale" style="margin-right: 8px; color: var(--accent-color); font-size: 0.9rem;"></i>
                            Valuation Impact in Dollars
                        </h3>
                        <div class="table-container" style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th style="text-align: right;">Allocation</th> 
                                        <th style="text-align: right;">Current Value</th>
                                        <th style="text-align: right;">Predicted Value</th>
                                        <th style="text-align: right;">Difference</th>
                                    </tr>
                                </thead>
                                <tbody id="desktop-dollar-valuation-body">
                                    <!-- Results will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.8rem; color: var(--text-muted-color);">
                            <strong>Note:</strong> Predicted value is based on the intrinsic value calculation. 
                            Positive differences (green) indicate potential value gain if the asset returns to predicted value.
                            Negative differences (red) indicate potential value loss if the asset returns to predicted value.
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Daily Performance</h2>
                     <table>
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Previous</th>
                                <th>Today</th>
                                <th>Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>SP500</td>
                                <td>5,268.05</td>
                                <td>5,363.36</td>
                                <td class="positive">1.81%</td>
                            </tr>
                            <tr>
                                <td>NASDAQ</td>
                                <td>16,367.31</td>
                                <td>16,724.46</td>
                                <td class="positive">2.06%</td>
                            </tr>
                            <tr>
                                <td>International (IXUS)</td>
                                <td>$65.71</td>
                                <td>$67.47</td>
                                <td class="positive">2.68%</td>
                            </tr>
                             <tr>
                                <td>Bonds (BND)</td>
                                <td>$72.10</td>
                                <td>$72.02</td>
                                <td class="negative">-0.11%</td>
                            </tr>
                            <tr>
                                <td>Money Market</td>
                                <td>$1.00</td>
                                <td>$1.00</td>
                                <td>0.00%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                 <div class="card card-large">
                    <h2>Valuation Details</h2>
                     <table>
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Predicted</th>
                                <th>Overprice</th>
                                <th>Threshold (vs MM)</th>
                                <th>Assoc. Date</th>
                                <th>Months to Even</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>SP500</td>
                                <td>4,570.69</td>
                                <td class="negative">17.34%</td>
                                <td>29.08%</td>
                                <td>9/18/2027</td>
                                <td>29.21</td>
                            </tr>
                            <tr>
                                <td>NASDAQ</td>
                                <td>15,639.76</td>
                                <td class="negative">6.94%</td>
                                <td>49.19%</td>
                                <td>12/23/2025</td>
                                <td>8.38</td>
                            </tr>
                            <tr>
                                <td>International (IXUS)</td>
                                <td>$66.96</td>
                                <td class="negative">0.77%</td>
                                <td class="negative">4.97%</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                             <tr>
                                <td>Bonds (BND)</td>
                                <td>$1,891.06</td>
                                <td class="positive">-15.24%</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>Money Market</td>
                                <td>$1.00</td>
                                <td>0%</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                 </div>
             </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <div class="logo">
                        <div class="logo-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="logo-text">IVDAR</div>
                    </div>
                    <p class="footer-tagline">An Enlightened Approach to Long Term Investing</p>
                </div>
                
                <div class="footer-links">
                    <div class="footer-section">
                        <h3>Platform</h3>
                        <ul>
                            <li><a href="#">Dashboard</a></li>
                            <li><a href="#">Portfolio</a></li>
                            <li><a href="#">Analytics</a></li>
                            <li><a href="#">Market</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3>Support</h3>
                        <ul>
                            <li><a href="#">Documentation</a></li>
                            <li><a href="#">Help Center</a></li>
                            <li><a href="#">Contact Us</a></li>
                            <li><a href="#">FAQs</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3>Legal</h3>
                        <ul>
                            <li><a href="#">Privacy Policy</a></li>
                            <li><a href="#">Terms of Service</a></li>
                            <li><a href="#">Disclaimer</a></li>
                            <li><a href="#">Security</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="copyright">
                    <p>&copy; 2025 IVDAR. All rights reserved.</p>
                </div>
                <div class="social-links">
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                    <a href="#" aria-label="GitHub"><i class="fab fa-github"></i></a>
                    <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Chart Options Helper
        function getChartOptions(theme) {
             const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
             const mutedColor = getComputedStyle(document.documentElement).getPropertyValue('--text-muted-color').trim();
             const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
             const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
             const fontFamily = getComputedStyle(document.documentElement).getPropertyValue('--font-family').trim();

            return {
                 // Modern color palette
                 colors: ["#3B82F6", "#60A5FA", "#FBBF24", "#8B5CF6", "#10B981"], // Blue-500, Blue-400, Amber-400, Purple-500, Emerald-500
                 chart: {
                     foreColor: textColor,
                     toolbar: { show: false },
                     animations: { 
                        enabled: true, 
                        speed: 800,
                        animateGradually: {
                            enabled: true,
                            delay: 150
                        },
                        dynamicAnimation: {
                            enabled: true,
                            speed: 350
                        }
                     },
                     fontFamily: fontFamily,
                     background: 'transparent',
                     dropShadow: {
                        enabled: true,
                        top: 3,
                        left: 3,
                        blur: 5,
                        color: '#000',
                        opacity: 0.2
                     }
                 },
                 grid: {
                     borderColor: gridColor,
                     strokeDashArray: 3,
                     position: 'back',
                     xaxis: {
                        lines: {
                            show: true,
                            opacity: 0.1
                        }
                     },
                     yaxis: {
                        lines: {
                            show: true,
                            opacity: 0.1
                        }
                     },
                     padding: {
                         top: 10,
                         right: 10, 
                         bottom: 10,
                         left: 10
                     }
                 },
                 xaxis: {
                     labels: {
                        style: {
                            colors: mutedColor,
                            fontSize: '12px',
                            fontWeight: 500
                        }
                     },
                     axisBorder: { show: false },
                     axisTicks: { show: true, color: gridColor, height: 4 },
                     title: {
                        style: {
                            color: mutedColor,
                            fontSize: '12px',
                            fontWeight: 500
                        }
                     },
                     crosshairs: {
                        show: true,
                        position: 'back',
                        stroke: {
                            color: accentColor,
                            width: 1,
                            dashArray: 3
                        }
                     }
                 },
                 yaxis: {
                     labels: {
                        style: {
                            colors: mutedColor,
                            fontSize: '12px',
                            fontWeight: 500
                        },
                        formatter: (value) => { return value.toFixed(1) + '%' }
                     },
                     title: {
                        style: {
                            color: mutedColor,
                            fontSize: '12px',
                            fontWeight: 500
                        }
                     }
                 },
                 tooltip: {
                     theme: 'dark',
                     style: {
                        fontSize: '12px',
                        fontFamily: fontFamily
                    },
                    x: { show: true },
                    marker: { 
                        show: true,
                        fillColors: ["#3B82F6", "#60A5FA", "#FBBF24", "#8B5CF6"]
                    },
                    custom: function({ series, seriesIndex, dataPointIndex, w }) {
                        return '<div class="custom-tooltip">' +
                            '<span class="tooltip-marker" style="background-color:' + 
                            w.config.colors[seriesIndex] + '"></span>' +
                            '<span class="tooltip-series">' + w.config.series[seriesIndex].name + ': </span>' +
                            '<span class="tooltip-value">' + series[seriesIndex][dataPointIndex].toFixed(2) + '%</span>' +
                            '</div>';
                    }
                 },
                 legend: {
                      fontFamily: fontFamily,
                      fontSize: '12px',
                      labels: { colors: mutedColor },
                      itemMargin: {
                        horizontal: 10,
                        vertical: 5
                      },
                      markers: {
                         width: 12,
                         height: 12,
                         radius: 6,
                         offsetY: 1
                       },
                       onItemClick: {
                         toggleDataSeries: false
                       }
                 },
                 title: { 
                     style: {
                         fontSize: '18px', 
                         fontWeight: '600',
                         fontFamily: fontFamily,
                         color: textColor
                     }
                 },
                 stroke: {
                    width: 3,
                    curve: 'smooth',
                    lineCap: 'round'
                 },
                 plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded',
                        borderRadius: 5,
                        dataLabels: {
                            position: 'top',
                        },
                    },
                    pie: {
                        donut: {
                            size: '65%',
                            background: 'transparent',
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    fontSize: '14px',
                                    fontWeight: 600,
                                    offsetY: -8,
                                    color: textColor
                                },
                                value: {
                                    show: true,
                                    fontSize: '24px',
                                    fontWeight: 700,
                                    offsetY: 4,
                                    color: textColor
                                },
                                total: {
                                     show: true,
                                     color: textColor,
                                     fontWeight: 700,
                                     fontSize: '16px',
                                     label: 'Total'
                                }
                            }
                        }
                    },
                    radialBar: {
                        hollow: {
                            margin: 15,
                            size: '70%'
                        },
                        track: {
                            background: 'rgba(255, 255, 255, 0.1)',
                            strokeWidth: '97%'
                        },
                        dataLabels: {
                            name: {
                                fontSize: '14px',
                                color: textColor,
                                offsetY: 10
                            },
                            value: {
                                fontSize: '24px',
                                fontWeight: 700,
                                color: textColor
                            }
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'vertical',
                        shadeIntensity: 0.4,
                        inverseColors: false,
                        opacityFrom: 1,
                        opacityTo: 0.85,
                        stops: [0, 95]
                    }
                },
                dataLabels: {
                    enabled: false,
                     style: {
                         fontSize: '11px',
                         fontFamily: fontFamily,
                         fontWeight: '600',
                         colors: ['#fff']
                     },
                     dropShadow: {
                        enabled: true, top: 1, left: 1, blur: 2, color: '#000', opacity: 0.5
                     }
                },
                states: {
                    hover: {
                        filter: {
                            type: 'lighten',
                            value: 0.12
                        }
                    },
                    active: {
                        filter: {
                            type: 'darken',
                            value: 0.12
                        }
                    }
                }
             };
         }

        // --- Allocation Chart (Donut) ---
        // let selectedAllocationIndex = -1; // Track selected slice (Removed, logic now in updateAllocationDetails)
        const initialTotalLabelOptions = {
            show: false, // Hide the center label completely
            label: 'Total Stock',
            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
            formatter: function (w) {
                const stockTotal = w.globals.series
                    .slice(0, 3) // SP500, NASDAQ, International
                    .reduce((a, b) => a + b, 0);
                return stockTotal.toFixed(2) + '%'
            }
        };

        const allocationOptions = {
            ...getChartOptions('dark'),
            series: [10.23, 33.84, 27.70, 3.57, 24.67],
            chart: {
                ...getChartOptions('dark').chart,
                type: 'donut',
                height: 380,
                events: {
                    dataPointSelection: function(event, chartContext, config) {
                        const seriesIndex = config.dataPointIndex;
                        updateAllocationCenter(seriesIndex, allocationChart);
                    },
                    legendClick: function(chartContext, seriesIndex, config) {
                        updateAllocationCenter(seriesIndex, allocationChart);
                        return false; // Prevent default legend behavior (hiding the series)
                    }
                }
            },
             title: {
                 text: 'Target Asset Allocation',
                 align: 'left',
                 style: {
                     color: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(), 
                     fontSize: '18px',
                     fontWeight: '600'
                 }
             },
            labels: ['SP500', 'NASDAQ', 'International', 'Bonds', 'Money Market'],
            colors: ["#3B82F6", "#60A5FA", "#FBBF24", "#8B5CF6", "#10B981"], // Blue-500, Blue-400, Amber-400, Purple-500, Emerald-500
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        background: 'transparent',
                        labels: {
                            show: true,
                            total: initialTotalLabelOptions
                        }
                    },
                    customScale: 0.9,
                    expandOnClick: false,
                    offsetY: 20
                }
            },
            states: {
                hover: {
                    filter: {
                        type: 'lighten',
                        value: 0.12
                    }
                },
                active: {
                    filter: {
                        type: 'none',
                        value: 0
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val.toFixed(2) + "%";
                    },
                    title: {
                        formatter: (seriesName) => seriesName + ":"
                    }
                }
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'horizontal',
                    shadeIntensity: 0.5,
                    gradientToColors: undefined,
                    inverseColors: false,
                    opacityFrom: 1,
                    opacityTo: 0.9,
                    stops: [0, 100]
                }
            },
            stroke: {
                width: 1,
                curve: 'smooth',
                colors: ['rgba(0,0,0,0.2)']
            },
            legend: {
                position: 'right',
                offsetY: 60,
                height: 230,
                fontSize: '13px',
                markers: {
                    width: 12,
                    height: 12,
                    radius: 6
                },
                itemMargin: {
                    horizontal: 10,
                    vertical: 5
                }
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: '100%'
                    },
                    legend: {
                        position: 'bottom',
                        offsetY: 0,
                        height: 'auto'
                    }
                }
            }],
            dataLabels: {
                enabled: true,
                formatter: function(val, opts) {
                    return opts.w.globals.series[opts.seriesIndex].toFixed(1) + '%';
                },
                style: {
                    fontSize: '11px',
                    fontWeight: '600'
                },
                dropShadow: {
                    enabled: true,
                    top: 1,
                    left: 1,
                    blur: 2,
                    opacity: 0.5
                }
            }
        };

        // Function to update the center of the allocation chart
        // function updateAllocationCenter(seriesIndex, chart) { ... } // Removed, replaced by updateAllocationDetails

        // --- Estimated Returns Chart Data (Scenarios) ---
        const baseReturns = {
            series: [{ name: 'Growth', data: [4.26, 10.15, 2.08, 0] }, { name: 'Dividends', data: [1.27, 0.63, 3.35, 4.35] }, { name: 'Total Return', data: [5.53, 10.78, 5.43, 4.35] }],
            description: "Expected market returns based on historical averages and current conditions."
        };
        const optimisticReturns = {
            series: [{ name: 'Growth', data: [6.5, 14.0, 4.0, 0.1] }, { name: 'Dividends', data: [1.3, 0.7, 3.4, 4.4] }, { name: 'Total Return', data: [7.8, 14.7, 7.4, 4.5] }],
            description: "Potential returns in a strong market environment with favorable economic factors."
        };
        const pessimisticReturns = {
            series: [{ name: 'Growth', data: [1.0, 3.5, 0.5, -0.1] }, { name: 'Dividends', data: [1.2, 0.6, 3.2, 4.0] }, { name: 'Total Return', data: [2.2, 4.1, 3.7, 3.9] }],
            description: "Potential returns in a weaker market with economic headwinds or corrections."
        };

        // --- Estimated Returns Chart Options ---
        // Note: BND is excluded due to #DIV/0! in original data
        const returnsOptions = {
            ...getChartOptions('dark'), // Start with base options
            series: baseReturns.series, // Initialize with base case data
            chart: {
                ...getChartOptions('dark').chart, // Inherit base chart options
                type: 'bar',
                height: 380, // Increased height
                stacked: false,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%', // Reduced width to create more space between bars
                    borderRadius: 4, // Adjusted radius
                    endingShape: 'rounded',
                    dataLabels: {
                        position: 'top',
                    }
                },
            },
            dataLabels: {
                enabled: true, // Enable data labels for bars
                offsetY: -20, // Adjusted offset for better positioning
                style: {
                    fontSize: '10px', // Slightly increased font size
                    colors: ["#FFF"],
                    fontWeight: 500 // Adjust weight
                },
                formatter: function (val) {
                    // Handle potential null/undefined values gracefully
                    return typeof val === 'number' ? val.toFixed(1) + "%" : '';
                },
                background: {
                    enabled: false
                }
            },
            stroke: {
                show: true,
                width: 1,
                colors: ['transparent']
            },
            title: {
                text: 'Est. 1-Year Return (%)',
                align: 'left',
                style: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim(), 
                    fontSize: '16px'
                }
            },
            xaxis: {
                ...getChartOptions('dark').xaxis, // Inherit base x-axis options
                categories: ['SP500', 'NASDAQ', 'Intl (IXUS)', 'MM'],
            },
            yaxis: {
                ...getChartOptions('dark').yaxis, // Inherit base y-axis options
                title: {
                    text: '% Return'
                },
                labels: {
                    ...getChartOptions('dark').yaxis.labels,
                    formatter: function (val) {
                        return val.toFixed(1) + "%";
                    }
                }
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'vertical',
                    shadeIntensity: 0.2,
                    gradientToColors: undefined,
                    inverseColors: false,
                    opacityFrom: 1,
                    opacityTo: 0.85,
                    stops: [0, 100]
                }
            },
            tooltip: {
                ...getChartOptions('dark').tooltip, // Inherit base tooltip options
                shared: true,
                intersect: false,
                y: {
                    formatter: function (val) {
                        return val.toFixed(2) + "%"
                    }
                }
            },
            legend: {
                position: 'top',
                horizontalAlign: 'left',
                offsetX: 40
            }
        };

        // --- Market Valuation Data --- 
        const initialValuationData = {
            categories: ['SP500', 'NASDAQ', 'Intl (IXUS)', 'Bonds (BND)'],
            seriesData: [17.34, 6.94, 0.77, -15.24],
            // Function to get colors based on data - Using new theme colors
            getColors: (data) => data.map(value => 
                value > 0 ? 'var(--negative-color)' : value < 0 ? 'var(--positive-color)' : 'var(--text-muted-color)' // Use CSS vars
            )
        };
        // Note: Cannot directly use CSS variables for ApexCharts `colors` array during initialization.
        // We'll apply them dynamically or use hex codes. Using hex for simplicity here.
        initialValuationData.colors = initialValuationData.seriesData.map(value => 
             value > 0 ? '#E53E3E' : value < 0 ? '#38A169' : '#A0AEC0'
        );

        // --- Market Valuation Chart Options --- 
        const valuationOptions = {
            ...getChartOptions('dark'),
            series: [{
                name: 'Valuation',
                data: initialValuationData.seriesData // Use initial data
            }],
            chart: {
                ...getChartOptions('dark').chart,
                type: 'bar',
                height: 380,
                animations: {
                    enabled: true,
                    speed: 500,
                    animateGradually: {
                        enabled: false, // Disable gradual animation for sorting
                        delay: 0
                    }
                }
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    distributed: true,
                    barHeight: '70%', // Increased height for better visibility
                    borderRadius: 4, // Adjusted radius
                    dataLabels: {
                        position: 'center',
                    },
                }
            },
            colors: initialValuationData.colors, // Use initial colors
            dataLabels: {
                enabled: true,
                formatter: function(val) {
                    return val > 0 ? '+' + val.toFixed(1) + '%' : val.toFixed(1) + '%';
                },
                offsetX: -2, // Adjust offset slightly for horizontal bars
                style: {
                    fontSize: '11px', // Adjusted size
                    fontWeight: '600',
                    colors: ['#fff']
                },
                background: {
                    enabled: false
                },
                dropShadow: {
                    enabled: true,
                    top: 1, // Adjusted shadow for better visibility
                    left: 1,
                    blur: 1,
                    opacity: 0.6
                }
            },
            stroke: {
                width: 0
            },
            xaxis: {
                categories: initialValuationData.categories, // Use initial categories
                labels: {
                    formatter: function(val) {
                        return val + '%';
                    }
                },
                axisBorder: {
                    show: false
                },
                axisTicks: {
                    show: false
                }
            },
            yaxis: {
                labels: {
                    style: {
                        fontWeight: 500
                    }
                }
            },
            title: {
                text: 'Asset Valuation Status',
                align: 'left',
                style: {
                    fontSize: '16px',
                    fontWeight: 600
                }
            },
            subtitle: {
                text: 'Positive % = overpriced, Negative % = underpriced',
                align: 'left',
                style: {
                    fontSize: '12px',
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted-color').trim()
                }
            },
            tooltip: {
                theme: 'dark',
                y: {
                    title: {
                        formatter: function() {
                            return 'Valuation:';
                        }
                    },
                    formatter: function(val) {
                        if (val > 0) {
                            return 'Overpriced by ' + val.toFixed(2) + '%';
                        } else if (val < 0) {
                            return 'Underpriced by ' + Math.abs(val).toFixed(2) + '%';
                        } else {
                            return 'Fair value';
                        }
                    }
                }
            },
            annotations: {
                xaxis: [{
                    x: 0,
                    strokeDashArray: 0,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                    label: {
                        borderColor: 'transparent',
                        style: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted-color').trim(),
                            background: 'transparent',
                            fontSize: '10px'
                        },
                        text: 'Fair Value',
                        position: 'top'
                    }
                }]
            },
            grid: {
                xaxis: {
                    lines: {
                        show: true
                    }
                },
                yaxis: {
                    lines: {
                        show: false
                    }
                },
                padding: {
                    top: 0,
                    right: 0,
                    bottom: 0,
                    left: 10
                }
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'horizontal',
                    shadeIntensity: 0.4,
                    inverseColors: false,
                    opacityFrom: 1,
                    opacityTo: 0.8,
                    stops: [0, 100]
                }
            },
            states: {
                hover: {
                    filter: {
                        type: 'lighten',
                        value: 0.12
                    }
                },
                active: {
                    allowMultipleDataPointsSelection: false,
                    filter: {
                        type: 'darken',
                        value: 0.35
                    }
                }
            }
        };

        // --- Enhanced Interactive Allocation Chart ---
        // Data for allocation chart
        const allocations = {
            series: [10.23, 33.84, 27.70, 3.57, 24.67],
            labels: ['SP500', 'NASDAQ', 'International', 'Bonds', 'Money Market'],
            colors: ["#4A90E2", "#7ABFFF", "#F6E05E", "#ED8936", "#A779E9"], // Primary Blue, Light Blue, Yellow, Orange, Purple
            descriptions: [
                "Large-cap U.S. equities (S&P 500 index).", // Shortened
                "Tech-focused U.S. equities (NASDAQ index).", // Shortened
                "International stocks (developed & emerging).", // Shortened
                "Fixed income securities for stability.", // Shortened
                "Cash & equivalents, high liquidity." // Shortened
            ],
            risks: ["Medium", "High", "Medium-High", "Low", "Very Low"],
            horizons: ["Long-term", "Long-term", "Long-term", "Medium-term", "Short-term"]
        };

        // Common options for both chart types
        const commonChartOptions = {
            ...getChartOptions('dark'),
            series: allocations.series,
            labels: allocations.labels,
            colors: allocations.colors,
            title: {
                text: 'Target Asset Allocation',
                align: 'left',
                style: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim(), 
                    fontSize: '18px'
                }
            },
            tooltip: {
                ...getChartOptions('dark').tooltip,
                custom: function ({ seriesIndex, w }) {
                    const value = w.globals.series[seriesIndex];
                    const label = w.globals.labels[seriesIndex];
                    return `
                        <div class="apexcharts-tooltip-custom">
                            <div style="font-weight:600; margin-bottom:5px;">${label}</div>
                            <div style="font-size:20px; font-weight:700; margin-bottom:5px;">${value.toFixed(2)}%</div>
                            <div style="font-size:12px;">${allocations.descriptions[seriesIndex]}</div>
                            <div style="font-size:12px; margin-top:5px;">
                                <span style="color:${allocations.colors[seriesIndex]}"></span> Risk: ${allocations.risks[seriesIndex]} | Horizon: ${allocations.horizons[seriesIndex]}
                            </div>
                        </div>
                    `;
                }
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: '100%'
                    },
                    legend: {
                        position: 'bottom',
                        offsetY: 0,
                        height: 'auto'
                    }
                }
            }]
        };

        // Donut chart options
        const donutOptions = {
            ...commonChartOptions,
            chart: {
                ...commonChartOptions.chart,
                type: 'donut',
                events: {
                    dataPointSelection: function(event, chartContext, config) {
                        updateAllocationDetails(config.dataPointIndex);
                    },
                    dataPointMouseEnter: function(event, chartContext, config) {
                        const seriesIndex = config.dataPointIndex;
                        document.querySelector('#allocation-chart').style.cursor = 'pointer';
                    },
                    dataPointMouseLeave: function(event, chartContext, config) {
                        document.querySelector('#allocation-chart').style.cursor = 'default';
                    }
                }
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        background: 'transparent',
                        labels: {
                            show: false, // Hide center labels completely
                            total: {
                                show: false,
                                label: 'Total Allocation',
                                fontSize: '13px',
                                fontWeight: 600,
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim()
                            }
                        }
                    },
                    customScale: 0.9,
                    offsetY: 10,
                    expandOnClick: false
                }
            },
            legend: {
                position: 'bottom',
                fontSize: '12px', // Adjusted size
                itemMargin: {
                    horizontal: 8, // Adjust spacing
                    vertical: 4
                },
                onItemClick: {
                    toggleDataSeries: false
                },
                markers: {
                    width: 12,
                    height: 12,
                    radius: 6
                }
            },
            stroke: {
                show: true,
                width: 2,
                colors: ['rgba(0,0,0,0.1)']
            },
            states: {
                hover: {
                    filter: {
                        type: 'darken',
                        value: 0.15
                    }
                },
                active: {
                    filter: {
                        type: 'darken',
                        value: 0.15
                    }
                }
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'horizontal',
                    shadeIntensity: 0.5,
                    opacityFrom: 1,
                    opacityTo: 0.9,
                    stops: [0, 100]
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function(val, opts) {
                    return opts.w.globals.series[opts.seriesIndex].toFixed(1) + '%';
                },
                style: {
                    fontSize: '10px',
                    fontWeight: '600',
                    fontFamily: getComputedStyle(document.documentElement).getPropertyValue('--font-family').trim()
                },
                dropShadow: {
                    enabled: true,
                    top: 1,
                    left: 1,
                    blur: 2,
                    color: '#000',
                    opacity: 0.45
                }
            }
        };

        // Bar chart options
        const barOptions = {
            ...commonChartOptions,
            chart: {
                ...commonChartOptions.chart,
                type: 'bar',
                height: 350,
                events: {
                    dataPointSelection: function(event, chartContext, config) {
                        updateAllocationDetails(config.dataPointIndex);
                    },
                    dataPointMouseEnter: function(event, chartContext, config) {
                        document.querySelector('#allocation-chart').style.cursor = 'pointer';
                    },
                    dataPointMouseLeave: function(event, chartContext, config) {
                        document.querySelector('#allocation-chart').style.cursor = 'default';
                    }
                }
            },
            series: [{
                name: 'Allocation',
                data: allocations.series
            }],
            plotOptions: {
                bar: {
                    distributed: true,
                    borderRadius: 6,
                    columnWidth: '60%',
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function(val) {
                    return val.toFixed(1) + '%';
                },
                offsetY: -20,
                style: {
                    fontSize: '10px',
                    colors: ["#fff"],
                    fontWeight: 600
                }
            },
            legend: {
                show: false
            },
            xaxis: {
                type: 'category',
                categories: allocations.labels,
                labels: {
                    show: true,
                    rotate: -45,
                    rotateAlways: false,
                    hideOverlappingLabels: true,
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Allocation (%)'
                },
                labels: {
                    formatter: function(val) {
                        return val.toFixed(1) + '%';
                    }
                },
                max: function(max) {
                    return Math.max(Math.ceil(max), 40); // Ensure we have enough space
                }
            },
            states: {
                hover: {
                    filter: {
                        type: 'lighten',
                        value: 0.12
                    }
                },
                active: {
                    filter: {
                        type: 'darken',
                        value: 0.15
                    }
                }
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'vertical',
                    shadeIntensity: 0.2,
                    opacityFrom: 1,
                    opacityTo: 0.9,
                    stops: [0, 100]
                }
            },
            tooltip: {
                y: {
                    formatter: function(val) {
                        return val.toFixed(2) + '%';
                    }
                }
            }
        };

        // Function to update allocation details panel
        function updateAllocationDetails(index) {
            if (index === undefined || index < 0) {
                // Reset to default
                document.querySelector('.allocation-info h3').textContent = 'Selected Asset';
                document.querySelector('.allocation-value').textContent = 'Click a segment to view details';
                return;
            }

            const label = allocations.labels[index];
            const value = allocations.series[index];
            const description = allocations.descriptions[index];
            const risk = allocations.risks[index];
            const horizon = allocations.horizons[index];
            
            // Update the details section
            const infoElement = document.querySelector('.allocation-info');
            const valueElement = document.querySelector('.allocation-value');
            
            if (!infoElement || !valueElement) return; // Add check
            
            infoElement.querySelector('h3').textContent = label;
            
            // Create a rich info display
            const detailHTML = `
                <div>${value.toFixed(2)}%</div>
                <div class="allocation-detail-text">${description}</div>
                <div class="allocation-metadata">
                    <span class="tag risk-${risk.toLowerCase().replace(/[\s_]+/g, '-')}">${risk} Risk</span>
                    <span class="tag horizon-tag">${horizon}</span>
                </div>
            `;
            valueElement.innerHTML = detailHTML;
            
            // Apply style for custom elements
            document.querySelectorAll('.allocation-detail-text').forEach(el => {
                el.style.fontSize = '0.85rem';
                el.style.marginTop = '8px';
                el.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-muted-color').trim();
                el.style.fontWeight = 'normal';
                el.style.lineHeight = '1.4';
                el.style.webkitTextFillColor = 'currentColor';
                el.style.backgroundClip = 'initial';
                el.style.background = 'none';
            });
            
            document.querySelectorAll('.allocation-metadata').forEach(el => {
                el.style.display = 'flex';
                el.style.gap = '8px';
                el.style.flexWrap = 'wrap';
                el.style.marginTop = '15px';
                el.style.justifyContent = 'center';
            });
            
            document.querySelectorAll('.tag').forEach(el => {
                el.style.display = 'inline-block';
                el.style.padding = '4px 10px';
                el.style.borderRadius = '20px';
                el.style.fontSize = '0.7rem';
                el.style.fontWeight = '600';
                el.style.color = '#fff';
                el.style.background = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                el.style.webkitTextFillColor = 'currentColor';
                el.style.backgroundClip = 'initial';
                el.style.letterSpacing = '0.5px';
                el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
            });
            
            document.querySelectorAll('.horizon-tag').forEach(el => {
                el.style.background = 'var(--accent-color)';
                el.style.opacity = '0.9';
            });
            
            // Apply risk-specific color
            const riskColors = {
                'very-low': 'var(--positive-color)',
                'low': '#38B2AC', // Teal color
                'medium': '#F6AD55', // Orange lighter
                'medium-high': '#F56565', // Red lighter
                'high': 'var(--negative-color)'
            };
            
            document.querySelectorAll('[class*="risk-"]').forEach(el => {
                const riskLevel = el.className.match(/risk-([\w-]+)/)[1];
                el.style.backgroundColor = riskColors[riskLevel] || getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                
                // All risk tags have white text for better contrast
                el.style.color = '#fff';
            });
            
            // Update stats (optional)
            const stockTotal = allocations.series.slice(0, 3).reduce((a, b) => a + b, 0);
            document.getElementById('stock-total').textContent = stockTotal.toFixed(2) + '%';
        }

        // Initialize charts after DOM content loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts
            let allocationChart;
            let currentAllocationChartType = 'donut';
            let returnsChart; // Declare returnsChart here
            let valuationChart; // Declare valuation chart variable
            
            // Chart Containers - Check if they exist
            const allocationChartContainer = document.querySelector("#allocation-chart");
            const returnsChartContainer = document.querySelector("#returns-chart");
            const valuationChartContainer = document.querySelector("#overprice-chart");

            // Initial Allocation Chart Render
            if (allocationChartContainer) {
                allocationChart = new ApexCharts(allocationChartContainer, donutOptions);
                allocationChart.render();
            } else {
                console.error("Allocation chart container not found");
            }
            
            // Button event handlers
            document.getElementById('view-as-donut').addEventListener('click', function() {
                if (currentAllocationChartType !== 'donut' && allocationChartContainer && allocationChart) {
                    document.getElementById('view-as-donut').classList.add('active');
                    document.getElementById('view-as-bar').classList.remove('active');
                    
                    // Destroy existing chart and create new one
                    allocationChart.destroy();
                    allocationChart = new ApexCharts(allocationChartContainer, donutOptions);
                    allocationChart.render();
                    currentAllocationChartType = 'donut';
                    
                    // Reset details
                    updateAllocationDetails(-1);
                }
            });
            
            document.getElementById('view-as-bar').addEventListener('click', function() {
                if (currentAllocationChartType !== 'bar' && allocationChartContainer && allocationChart) {
                    console.log("Switching to bar chart view");
                    
                    // Update button states
                    document.getElementById('view-as-donut').classList.remove('active');
                    document.getElementById('view-as-bar').classList.add('active');
                    
                    try {
                        // Create a bar-specific config that includes distributed colors
                        const barSpecificConfig = {
                            ...barOptions,
                            colors: allocations.colors, // Ensure colors are applied
                            chart: {
                                ...barOptions.chart,
                                animations: {
                                    enabled: true,
                                    animateGradually: {
                                        enabled: true,
                                        delay: 150
                                    },
                                    dynamicAnimation: {
                                        enabled: true,
                                        speed: 350
                                    }
                                }
                            }
                        };
                        
                        console.log("Bar chart config:", JSON.stringify(barSpecificConfig.series));
                        
                        // Destroy existing chart and create new one
                        allocationChart.destroy();
                        
                        allocationChartContainer.style.height = '350px'; // Ensure height is set for bar chart
                        allocationChartContainer.style.visibility = 'visible';
                        
                        allocationChart = new ApexCharts(allocationChartContainer, barSpecificConfig);
                        allocationChart.render();
                        currentAllocationChartType = 'bar';
                        
                        // Reset details
                        updateAllocationDetails(-1);
                    } catch (error) {
                        console.error("Error switching to bar chart:", error);
                    }
                }
            });
            
            // Initialize returns chart
            if (returnsChartContainer) {
                returnsChart = new ApexCharts(returnsChartContainer, returnsOptions);
                returnsChart.render();
            } else {
                console.error("Returns chart container not found");
            }

            // Add event listeners for returns scenario buttons
            const scenarioButtons = {
                'returns-base': baseReturns,
                'returns-optimistic': optimisticReturns,
                'returns-pessimistic': pessimisticReturns
            };
            const scenarioDescElement = document.getElementById('scenario-description');
            const returnsButtonsContainer = document.querySelector('.scenario-controls');

            // Only add listeners if the chart and buttons exist
            if (returnsChart && returnsButtonsContainer && scenarioDescElement) {
                Object.keys(scenarioButtons).forEach(buttonId => {
                    document.getElementById(buttonId).addEventListener('click', function() {
                        // Update button active state
                        returnsButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');

                        // Update chart and description
                        const scenarioData = scenarioButtons[buttonId];
                        returnsChart.updateSeries(scenarioData.series);
                        scenarioDescElement.textContent = scenarioData.description;
                    });
                });
            }
            
            // Initialize valuation chart
            if (valuationChartContainer) {
                valuationChart = new ApexCharts(valuationChartContainer, valuationOptions); // Initialize with base options
                valuationChart.render();
            } else {
                console.error("Valuation chart container not found");
            }
            
            // Add event listeners for valuation sort buttons
            const valuationSortControls = document.querySelector('.valuation-sort-controls');
            if (valuationChart && valuationSortControls) {
                valuationSortControls.addEventListener('click', function(event) {
                    if (event.target.tagName === 'BUTTON') {
                        // Update active button state
                        valuationSortControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');

                        // Combine categories and data for sorting
                        let items = initialValuationData.categories.map((category, index) => ({
                            category: category,
                            value: initialValuationData.seriesData[index]
                        }));

                        // Sort based on button ID
                        const sortType = event.target.id;
                        if (sortType === 'valuation-sort-overpriced') {
                            items.sort((a, b) => b.value - a.value); // Descending (most overpriced first)
                        } else if (sortType === 'valuation-sort-underpriced') {
                            items.sort((a, b) => a.value - b.value); // Ascending (most underpriced first)
                        } else { // Default sort (use original order)
                            // Reset items based on the original categories order
                             items = initialValuationData.categories.map((category, index) => ({
                                category: category,
                                value: initialValuationData.seriesData[index]
                            }));
                        }

                        // Extract sorted data
                        const sortedCategories = items.map(item => item.category);
                        const sortedData = items.map(item => item.value);
                        const sortedColors = initialValuationData.getColors(sortedData);

                        // Update chart
                        valuationChart.updateOptions({
                            xaxis: {
                                categories: sortedCategories
                            },
                            series: [{
                                data: sortedData
                            }],
                            colors: sortedColors
                        });
                    }
                });
            }
            
            // Add card hover effect
            document.querySelectorAll('.card, .summary-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    // Hover effects are now handled by CSS :hover pseudo-class
                });
                
                item.addEventListener('mouseleave', function() {
                    // this.style.transform = '';
                    // this.style.boxShadow = '';
                });
            });
            
            // Table row hover (Alternative using CSS :hover, preferred)
            // The CSS already handles this with: tbody tr:hover { background-color: var(--highlight-color); }
            // The JS listeners below can be removed if CSS is sufficient.
             document.querySelectorAll('tbody tr').forEach(row => {
                 row.addEventListener('mouseenter', function() {
                     // This JS is redundant if CSS :hover is defined and working
                 });
                 row.addEventListener('mouseleave', function() {
                     // This JS is redundant
                 });
             });

            // Portfolio Calculator
            const calculateBtn = document.getElementById('calculateBtn');
            const portfolioValueInput = document.getElementById('portfolioValue');
            const calculationResults = document.getElementById('calculationResults');
            const calculationResultsBody = document.getElementById('calculationResultsBody');
            const totalAmountSpan = document.getElementById('totalAmount');
            
            if (calculateBtn && portfolioValueInput && calculationResults && calculationResultsBody) {
                // Current prices from the performance table
                const currentPrices = {
                    'SP500': 5363.36,
                    'NASDAQ': 16724.46,
                    'International': 67.47,
                    'Bonds': 72.02,
                    'Money Market': 1.00
                };
                
                // Function to calculate and display allocation
                const calculatePortfolioAllocation = () => {
                    const portfolioValue = parseFloat(portfolioValueInput.value);
                    if (isNaN(portfolioValue) || portfolioValue <= 0) {
                        // Hide results if input is invalid
                        calculationResults.style.display = 'none';
                        // Hide other portfolio-related sections
                        document.getElementById('dollarReturnsSection').style.display = 'none';
                        document.getElementById('desktop-dollar-valuation-section').style.display = 'none';
                        return;
                    }
                    
                    // Clear previous results
                    calculationResultsBody.innerHTML = '';
                    
                    // Format for currency display
                    const formatter = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    // Get the allocation data (assuming this is from the chart)
                    const allocationData = allocations.series;
                    const assetLabels = allocations.labels;
                    
                    // Create rows for each asset
                    allocationData.forEach((percentage, index) => {
                        const amount = (percentage / 100) * portfolioValue;
                        const row = document.createElement('tr');
                        
                        // Get current price for this asset
                        let assetName = assetLabels[index];
                        let currentPrice = currentPrices[assetName] || 0;
                        let priceDisplay = assetName === 'SP500' || assetName === 'NASDAQ' ? 
                            currentPrice.toLocaleString() : formatter.format(currentPrice);
                        
                        row.innerHTML = `
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color);">${assetLabels[index]}</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right;">${percentage.toFixed(2)}%</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right; font-weight: 600;">${formatter.format(amount)}</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right;">${priceDisplay}</td>
                        `;
                        
                        calculationResultsBody.appendChild(row);
                    });
                    
                    // Add total row with strong styling
                    const totalRow = document.createElement('tr');
                    totalRow.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                    totalRow.innerHTML = `
                        <td style="padding: 10px 8px; font-weight: 700;">Total Portfolio</td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: 700;">100.00%</td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: 700;">${formatter.format(portfolioValue)}</td>
                        <td style="padding: 10px 8px; text-align: right;"></td>
                    `;
                    calculationResultsBody.appendChild(totalRow);
                    
                    // Update total amount display
                    totalAmountSpan.textContent = `Total: ${formatter.format(portfolioValue)}`;
                    
                    // Show the results with animation
                    calculationResults.style.display = 'block';
                    
                    // Update portfolio value display elsewhere on the page
                    const portfolioValueDisplay = document.getElementById('desktopPortfolioValueDisplay');
                    if (portfolioValueDisplay) {
                        portfolioValueDisplay.textContent = formatter.format(portfolioValue);
                    }
                    
                    // Update dollar returns section
                    updateDollarReturnSection(portfolioValue);
                    
                    // Update dollar valuation section
                    updateDollarValuationSection(portfolioValue);
                };
                
                // Function to update dollar returns section
                const updateDollarReturnSection = (portfolioValue) => {
                    const returnsSection = document.getElementById('dollarReturnsSection');
                    const returnsBody = document.getElementById('desktop-dollar-returns-body');
                    
                    if (!returnsSection || !returnsBody) return;
                    
                    // Clear previous results
                    returnsBody.innerHTML = '';
                    
                    // Get current scenario data
                    let currentScenario = baseReturns;
                    if (document.getElementById('returns-optimistic').classList.contains('active')) {
                        currentScenario = optimisticReturns;
                    } else if (document.getElementById('returns-pessimistic').classList.contains('active')) {
                        currentScenario = pessimisticReturns;
                    }
                    
                    // Get the total return series (index 2)
                    const totalReturnData = currentScenario.series[2].data;
                    
                    // Format for currency display
                    const formatter = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    // Create rows for applicable assets
                    allocations.series.forEach((percentage, index) => {
                        // Skip assets that don't have return data
                        if (index >= totalReturnData.length) return;
                        
                        const amount = (percentage / 100) * portfolioValue;
                        const returnPercent = totalReturnData[index];
                        const dollarsReturned = amount * (returnPercent / 100);
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color);">${allocations.labels[index]}</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right;">${formatter.format(amount)}</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right;">${returnPercent.toFixed(2)}%</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right; font-weight: 600; color: ${dollarsReturned >= 0 ? 'var(--positive-color)' : 'var(--negative-color)'}">
                                ${formatter.format(dollarsReturned)}
                            </td>
                        `;
                        
                        returnsBody.appendChild(row);
                    });
                    
                    // Calculate total return
                    let totalReturn = 0;
                    let totalInvestment = 0;
                    
                    allocations.series.forEach((percentage, index) => {
                        if (index >= totalReturnData.length) return;
                        
                        const amount = (percentage / 100) * portfolioValue;
                        totalInvestment += amount;
                        totalReturn += amount * (totalReturnData[index] / 100);
                    });
                    
                    // Add total row
                    const totalRow = document.createElement('tr');
                    totalRow.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                    
                    const totalReturnPercentage = (totalReturn / totalInvestment) * 100;
                    
                    totalRow.innerHTML = `
                        <td style="padding: 10px 8px; font-weight: 700;">Total</td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: 700;">${formatter.format(totalInvestment)}</td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: 700;">${totalReturnPercentage.toFixed(2)}%</td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: 700; color: ${totalReturn >= 0 ? 'var(--positive-color)' : 'var(--negative-color)'}">
                            ${formatter.format(totalReturn)}
                        </td>
                    `;
                    returnsBody.appendChild(totalRow);
                    
                    // Show the section
                    returnsSection.style.display = 'block';
                };
                
                // Function to update dollar valuation section
                const updateDollarValuationSection = (portfolioValue) => {
                    const valuationSection = document.getElementById('desktop-dollar-valuation-section');
                    const valuationBody = document.getElementById('desktop-dollar-valuation-body');
                    
                    if (!valuationSection || !valuationBody) return;
                    
                    // Don't show for small portfolio values to avoid clutter
                    if (portfolioValue < 5000) {
                        valuationSection.style.display = 'none';
                        return;
                    }
                    
                    // Clear previous results
                    valuationBody.innerHTML = '';
                    
                    // Predicted prices from the valuation details table
                    const predictedPrices = {
                        'SP500': 4570.69,
                        'NASDAQ': 15639.76,
                        'Intl (IXUS)': 66.96,
                        'Bonds (BND)': 1891.06
                    };
                    
                    // Current prices from the performance table
                    const currentPrices = {
                        'SP500': 5363.36,
                        'NASDAQ': 16724.46,
                        'International': 67.47,
                        'Bonds': 72.02,
                        'Money Market': 1.00
                    };
                    
                    // Format for currency display
                    const formatter = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    // Map categories to allocation labels
                    const categoryToAllocationIndex = {
                        'SP500': 0,
                        'NASDAQ': 1, 
                        'Intl (IXUS)': 2,
                        'Bonds (BND)': 3
                    };
                    
                    // Create rows for each asset
                    let assets = Object.keys(categoryToAllocationIndex);
                    let totalCurrentValue = 0;
                    let totalPredictedValue = 0;
                    
                    assets.forEach(assetName => {
                        const allocationIndex = categoryToAllocationIndex[assetName];
                        
                        // Skip if we can't map to an allocation
                        if (allocationIndex === undefined) return;
                        
                        const percentage = allocations.series[allocationIndex];
                        const currentAmount = (percentage / 100) * portfolioValue;
                        
                        // Skip if we don't have predicted price data for this asset
                        if (!predictedPrices[assetName]) return;
                        
                        // Get prices and calculate ratio
                        const currentPrice = currentPrices[assetName.replace('Intl (IXUS)', 'International').replace('Bonds (BND)', 'Bonds')];
                        const predictedPrice = predictedPrices[assetName];
                        
                        if (!currentPrice) return;
                        
                        // Calculate predicted value based on the ratio between predicted and current price
                        const ratio = predictedPrice / currentPrice;
                        const predictedValue = currentAmount * ratio;
                        const valueDifference = predictedValue - currentAmount;
                        
                        // Track totals
                        totalCurrentValue += currentAmount;
                        totalPredictedValue += predictedValue;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color);">${assetName}</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right;">${percentage.toFixed(2)}%</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right;">${formatter.format(currentAmount)}</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right;">${formatter.format(predictedValue)}</td>
                            <td style="padding: 10px 8px; border-bottom: 1px solid var(--border-color); text-align: right; font-weight: 600; color: ${valueDifference >= 0 ? 'var(--positive-color)' : 'var(--negative-color)'}">
                                ${formatter.format(valueDifference)}
                            </td>
                        `;
                        
                        valuationBody.appendChild(row);
                    });
                    
                    const totalDifference = totalPredictedValue - totalCurrentValue;
                    
                    // Add total row
                    const totalRow = document.createElement('tr');
                    totalRow.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                    
                    totalRow.innerHTML = `
                        <td style="padding: 10px 8px; font-weight: 700;">Total</td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: 700;"></td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: 700;">${formatter.format(totalCurrentValue)}</td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: 700;">${formatter.format(totalPredictedValue)}</td>
                        <td style="padding: 10px 8px; text-align: right; font-weight: 700; color: ${totalDifference >= 0 ? 'var(--positive-color)' : 'var(--negative-color)'}">
                            ${formatter.format(totalDifference)}
                        </td>
                    `;
                    
                    valuationBody.appendChild(totalRow);
                    
                    // Show the section
                    valuationSection.style.display = 'block';
                };
                
                // Set up event listeners for real-time updates
                portfolioValueInput.addEventListener('input', calculatePortfolioAllocation);
                
                // Also update on focus if there's already a value
                portfolioValueInput.addEventListener('focus', function() {
                    if (this.value) {
                        calculatePortfolioAllocation();
                    }
                });
                
                // Keep calculate button for fallback and accessibility
                calculateBtn.addEventListener('click', calculatePortfolioAllocation);
                
                // Allow pressing Enter to calculate
                portfolioValueInput.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        calculateBtn.click();
                    }
                });
                
                // Add a debounce timer for performance while typing
                let debounceTimer;
                portfolioValueInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(calculatePortfolioAllocation, 200);
                });
                
                // Add listeners to update dollar returns when scenarios change
                document.querySelectorAll('#returns-base, #returns-optimistic, #returns-pessimistic').forEach(button => {
                    button.addEventListener('click', function() {
                        const portfolioValue = parseFloat(portfolioValueInput.value);
                        if (!isNaN(portfolioValue) && portfolioValue > 0) {
                            updateDollarReturnSection(portfolioValue);
                        }
                    });
                });
                
                // Add listeners to update valuation section when sort options change
                document.querySelectorAll('#valuation-sort-default, #valuation-sort-overpriced, #valuation-sort-underpriced').forEach(button => {
                    button.addEventListener('click', function() {
                        // Just delay slightly to allow the chart to update first
                        setTimeout(() => {
                            const portfolioValue = parseFloat(portfolioValueInput.value);
                            if (!isNaN(portfolioValue) && portfolioValue > 0) {
                                updateDollarValuationSection(portfolioValue);
                            }
                        }, 300);
                    });
                });
            }
        });
    </script>
    
    <!-- Mobile menu JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            const navMenu = document.getElementById('nav-menu');
            
            if (mobileMenu && navMenu) {
                mobileMenu.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                    mobileMenu.classList.toggle('active');
                });
                
                // Close mobile menu when a link is clicked
                const navLinks = navMenu.querySelectorAll('a');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        navMenu.classList.remove('active');
                        mobileMenu.classList.remove('active');
                    });
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(event) {
                    const isClickInsideMenu = navMenu.contains(event.target);
                    const isClickOnToggle = mobileMenu.contains(event.target);
                    
                    if (!isClickInsideMenu && !isClickOnToggle && navMenu.classList.contains('active')) {
                        navMenu.classList.remove('active');
                        mobileMenu.classList.remove('active');
                    }
                });
            }
        });
    </script>

<script src="https://static.app/js/static.js" type="text/javascript"></script>
</body>
</html> 